### innodb 关键特性
* **Buffer Pool**
  - 缓冲池是mysql中一大块的内存区域，主要用来缓存各种数据，以提高性能，要为加载的数据分配页，有的页刷到磁盘可以释放，对于这么大的一片内存区域如何管理分配和释放页呢。mysql 中使用改造之后的LRU算法来管理这些页，这个LRU算法中有一个midpoint，热点数据存在new区中，不活跃的数据存在在old区中。新分配的页就放在old中，只要当在一定时间内被再次访问（是因为查询而不是数据库的预读），就会被加入到new中，这个时间可以通过全局的时间来控制
* **insert buffer**
  - 插入缓冲是提高插入性能的一种措施。数据插入的时候数据是按照主键顺序存放的，也就是存在一级索引里，数据是按照一级索引的顺序来存储的。在大多数情况下主键都是自增长的，插入的过程其实就是个顺序写，性能没有什么问题。但是对于二级索引来说，写入往往都是随机的，经常遇到要写的页不在缓冲池中，这是就要缺页中断，从磁盘调入页进内存，然后在写，这样一来就很慢了。为了解决二级索引写入慢的问题，就有了insert buffer，insert buffer 自身也是个b+ 树，当写二级索引的时候如果页不在缓冲池中，那么就直接写insert buffer，这样就快的很多了。但是这只是个临时的解决办法，最终还是要把insert buffer中的数据写入到页里面。
  - insert buffer bitmap 记录了二级索引页空间占用情况，以及哪些页的记录存在于insert buffer 中。当因为一些外部的原因导致页被加载到了缓冲池中（比如一个select），而恰好bitmap中记录了这个页有数据在insert buffer里面，那么就可以合并了。如果bitmap里面发现整体二级页空闲空间不多了，也会强制的加载页到内存进行合并。还有就是master线程在每秒或每10秒进行的合并。
  - insert buffer 不适用于唯一性索引，因为为了去检查是否违反唯一性约束，有可能要去检查和之前的记录是否重复，有可能要去磁盘上加载页，这样就违背了insert buffer 的设计初衷。
  - insert buffer 为什么加快了二级索引的插入速度，就是因为他减少了磁盘IO的操作次数。
* **doublewrite**
  - 部分写失效问题（partial page write）。innodb中的page大小是16k，而磁盘写入是512byte为单位的，也就是说512 bytes 可以原子写入，但是16k的page 无法保证原子写入，因此crash的时候有可能16k只写入一半。
  - 主要解决的是刷新脏页到磁盘过程中，如果os或者存储系统或者进程 crash 之后，double write 可以在后续的恢复数据过程中提供一定的保障能力, 假如说double write 写成功了，但是刷到各个表空间磁盘的时候crash了，在系统的恢复过程中可以使用double write备份的页，然后再结合redolog就可以完成恢复了。脏页不是直接被刷到磁盘中，先把准备flush到磁盘的脏页先写入到 double write buffer，然后立即sync到磁盘。这样就保证了也谢脏页在磁盘上有了一份备份了，然后在把double write buffer 中的数据flush到磁盘。其中double write buffer 写到磁盘是顺序写到系统表空间中，第二次write到磁盘是写到各个表空间中，是个随机写过程。
  - 疑问是：如果double write 写的过程中也没有成功，也就是说连备份都没有成功，那么岂不是还是白搭？
  - double write 只是面对部分写失效问题的被动解决方案，不是什么优点
  - 当double write 写成功后，页写入磁盘发生crash的情形，double write 方案才会起作用，可以利用double write 恢复 page
  - 当double write 自身也没有写成功，那么恢复的时候不会用double write，这个时候会用 事务日志(其实就是redo) 来恢复double write，然后才能用redo log 来恢复page
  - 疑问： 磁盘扇区是512bytes，传输也是以扇区为单位，但为什么可以保证扇区的写入是原子呢？会不会一个扇区只写入了一半？
    http://jm.taobao.org/2013/07/09/2923/ 这篇文章解释的比较清楚，磁盘的磁头其实一次只能写一个bit,所以 512byte 也是一位一位写的，完全有可能写一半的情况。但是磁盘每次都是在写完了一个512byte后给操作系统应答说写成功，写一半的情况就是没有写成功，写一次系统启动会把这些写一半的块清除掉，就相当于没有写。也就是说磁盘回答说这个扇区写成功了就一定是写到了物理介质上了。


